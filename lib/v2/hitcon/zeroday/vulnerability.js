const got = require('@/utils/got');
const cheerio = require('cheerio');

module.exports = async (ctx) => {
    const baseUrl = 'https://zeroday.hitcon.org/vulnerability';
    let url = baseUrl;

    const { type } = ctx.params;
    if (type) {
        url += `/${type}`;
    }

    const { data } = await got.get(url, {
        headers: {
            'user-agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:62.0) Firefox/62.0',
        },
    });

    const $ = cheerio.load(data);
    const items = $('.zdui-strip-list>li')
        .toArray()
        .map((el) => {
            const title = $(el).find('.title a');
            const vulData = $(el).find('.vul-data');
            const code = vulData
                .find('.code')
                .contents()
                .filter(function () {
                    return this.nodeType === 3;
                })
                .text();
            const risk = vulData.find('.risk span').eq(1).text();
            const vender = vulData.find('.vender').find('.v-name-full').text();
            const status = vulData
                .find('.status')
                .contents()
                .filter(function () {
                    return this.nodeType === 3;
                })
                .text();
            const date = vulData
                .find('.date')
                .contents()
                .filter(function () {
                    return this.nodeType === 3;
                })
                .text();
            const reporter = vulData.find('.zdui-author-badge').find('a>span').text();

            return {
                title: title.text(),
                link: title.attr('href'),
                description: `<ul>
                <li>${vender}</li>
                <li>ZDID: ${code}</li>
                <li>風險: ${risk}</li>
                <li>處理狀態: ${status}</li>
                <li>通報者: ${reporter}</li>
                <li>通報日期: ${date}</li>
                </ul>`,
            };
        });

    ctx.state.data = {
        title: 'HITCON ZeroDay',
        link: baseUrl,
        item: items,
    };
};
