name: PR - Docker build test

on:
    pull_request:
        branches:
            - master
        paths:
            - '.github/workflows/docker-test.yml'
            - 'lib/**'
            - 'Dockerfile'
            - 'package.json'
            - 'pnpm-lock.yaml'
        types: [opened, reopened, synchronize, edited]
    # Please, always create a pull request instead of push to master.

concurrency:
    group: docker-test-${{ github.ref_name }}
    cancel-in-progress: true

jobs:
    test:
        name: Docker build & tests
        permissions:
            pull-requests: write
            attestations: write
        runs-on: ubuntu-latest
        timeout-minutes: 10
        steps:
            - name: Checkout
              uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

            - name: Set up Docker Buildx # needed by `cache-from`
              uses: docker/setup-buildx-action@e468171a9de216ec08956ac3ada2f0791b6bd435 # v3.11.1

            - name: Extract Docker metadata
              id: meta
              uses: docker/metadata-action@c299e40c65443455700f0fdfc63efafe5b349051 # v5.10.0
              with:
                  images: rsshub
                  flavor: latest=true

            - name: Build Docker image
              uses: docker/build-push-action@263435318d21b8e681c14492fe198d362a7d2c83 # v6.18.0
              with:
                  context: .
                  build-args: PUPPETEER_SKIP_DOWNLOAD=0 # also test bundling Chromium
                  load: true
                  tags: ${{ steps.meta.outputs.tags }}
                  labels: ${{ steps.meta.outputs.labels }}
                  platforms: linux/amd64 # explicit
                  cache-from: |
                      type=registry,ref=${{ secrets.DOCKER_USERNAME }}/rsshub:chromium-bundled
                      type=gha,scope=docker-release
                  outputs: type=docker,compression=zstd,force-compression=true # load: true means docker output type

            - name: Pull Request Labeler
              if: ${{ failure() }}
              uses: actions-cool/issues-helper@3809910bc12872edc9b8132f122069ac16cd16ee # v3.7.3
              with:
                  actions: 'add-labels'
                  token: ${{ secrets.GITHUB_TOKEN }}
                  issue-number: ${{ github.event.pull_request.number }}
                  labels: 'auto: DO NOT merge'

            - name: Test Docker image
              run: bash scripts/docker/test-docker.sh

            - name: Export Docker image
              run: docker save rsshub:latest | zstdmt -o rsshub.tar.zst

            - name: Upload Docker image
              uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
              with:
                  name: docker-image
                  path: rsshub.tar.zst
                  retention-days: 1
